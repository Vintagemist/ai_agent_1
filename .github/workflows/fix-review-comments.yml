# Fix code review comments â€” runs automatically on PR review comments or manually from Actions tab
name: agent name is Fix code review comments dummy changes

on:
  # Automatic: when a reviewer adds a line-level comment on the PR
  pull_request_review_comment:
    types: [created]
  # Automatic: when a full review is submitted (e.g. "Request changes" or "Comment")
  pull_request_review:
    types: [submitted]
  # Manual: run from Actions â†’ Fix code review comments â†’ Run workflow
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to fix (PR branch)'
        required: true
        default: ''
      pr_number:
        description: 'PR number (optional; inferred from branch if not set)'
        required: false
        default: ''

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

jobs:
  fix-review-comments:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required for git push dummy change
      pull-requests: write   # required for PR comments
    # For automatic runs, only run when there is a PR (skip for workflow_dispatch if branch has no PR)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review_comment' && github.event.pull_request) ||
      (github.event_name == 'pull_request_review' && github.event.pull_request)
    steps:
      - name: Security checks
        id: security
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // For workflow_dispatch, skip security checks (assume authorized)
            if (context.eventName === 'workflow_dispatch') {
              core.info('Manual workflow dispatch - security checks passed');
              core.setOutput('allowed', 'true');
              return;
            }

            if (!pr) {
              core.warning('No PR found in context');
              core.setOutput('allowed', 'false');
              return;
            }

            // Check 1: Skip if PR is from a fork
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              core.warning('PR is from a fork - skipping auto-fix for security');
              core.setOutput('allowed', 'false');
              return;
            }

            // Check 2: Verify comment author has write access
            const comment = context.payload.comment || context.payload.review;
            if (comment) {
              try {
                const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: comment.user.login
                });

                if (!['admin', 'write'].includes(permission.permission)) {
                  core.warning(`Comment author @${comment.user.login} lacks write access (${permission.permission}) - skipping`);
                  core.setOutput('allowed', 'false');
                  return;
                }

                core.info(`Comment author @${comment.user.login} has ${permission.permission} access - proceeding`);
              } catch (error) {
                core.warning(`Could not verify permissions for @${comment.user.login}: ${error.message}`);
                core.setOutput('allowed', 'false');
                return;
              }
            }

            core.info('Security checks passed');
            core.setOutput('allowed', 'true');

      - name: Checkout repository
        if: steps.security.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          # Use branch name (not SHA) so we stay on a branch and can push after applying fixes
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.event.pull_request.head.ref }}
          token: ${{ env.GH_TOKEN }}

      - name: Load configuration
        if: steps.security.outputs.allowed == 'true'
        id: config
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            const defaultConfig = {
              enabled: true,
              triggers: {
                keywords: ['@auto-fix', '/fix', '[auto-fix]'],
                labels: ['auto-fix-enabled'],
                auto_apply: false
              },
              ai: {
                model: 'claude-opus-4-6',
                confidence_threshold: 'medium'
              },
              limits: {
                max_comments_per_pr: 20,
                max_file_size_bytes: 1048576,
                max_lines_per_comment: 100
              }
            };

            let config = { ...defaultConfig };
            const configPath = '.github/auto-fix.yml';

            if (fs.existsSync(configPath)) {
              try {
                const fileContent = fs.readFileSync(configPath, 'utf8');
                const userConfig = yaml.load(fileContent);
                config = { ...defaultConfig, ...userConfig };
                core.info('Loaded configuration from .github/auto-fix.yml');
              } catch (error) {
                core.warning(`Failed to load config file: ${error.message}. Using defaults.`);
              }
            } else {
              core.info('No config file found, using defaults');
            }

            // Check if agent is enabled
            if (!config.enabled) {
              core.warning('Auto-fix agent is disabled in configuration');
              core.setOutput('enabled', 'false');
              return;
            }

            core.setOutput('enabled', 'true');
            core.setOutput('model', config.ai.model);
            core.setOutput('confidence_threshold', config.ai.confidence_threshold);
            core.setOutput('max_comments', config.limits.max_comments_per_pr.toString());
            core.setOutput('auto_apply', config.triggers.auto_apply.toString());

            // Save full config for later steps
            fs.writeFileSync(
              process.env.RUNNER_TEMP + '/auto-fix-config.json',
              JSON.stringify(config, null, 2)
            );

      - name: Set PR number and fetch comments
        if: steps.security.outputs.allowed == 'true' && steps.config.outputs.enabled == 'true'
        id: pr_and_comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let prNumber = null;

            // Determine PR number based on event type
            if (context.eventName === 'workflow_dispatch') {
              const inputPrNumber = '${{ github.event.inputs.pr_number }}';
              if (inputPrNumber) {
                prNumber = parseInt(inputPrNumber);
              } else {
                // Query for PR by branch name
                const branch = '${{ github.event.inputs.branch }}';
                if (branch) {
                  try {
                    const { data: prs } = await github.rest.pulls.list({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      head: `${context.repo.owner}:${branch}`,
                      state: 'open'
                    });
                    if (prs.length > 0) {
                      prNumber = prs[0].number;
                    }
                  } catch (error) {
                    core.warning(`Could not find PR for branch ${branch}: ${error.message}`);
                  }
                }
              }
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }

            core.setOutput('pr_number', prNumber ? prNumber.toString() : '');

            // Fetch review comments if PR exists
            if (!prNumber) {
              core.info('No PR found for this branch');
              fs.writeFileSync(path.join(process.env.RUNNER_TEMP, 'review-comments.json'), '[]');
              return;
            }

            core.info(`Fetching review comments for PR #${prNumber}`);

            try {
              // Fetch all review comments (paginated)
              const comments = await github.paginate(
                github.rest.pulls.listReviewComments,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                }
              );

              const outputPath = path.join(process.env.RUNNER_TEMP, 'review-comments.json');
              fs.writeFileSync(outputPath, JSON.stringify(comments, null, 2));

              core.info(`Fetched ${comments.length} review comment(s)`);
            } catch (error) {
              core.error(`Failed to fetch review comments: ${error.message}`);
              fs.writeFileSync(path.join(process.env.RUNNER_TEMP, 'review-comments.json'), '[]');
            }

      - name: Set up Python
        if: steps.security.outputs.allowed == 'true' && steps.config.outputs.enabled == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.security.outputs.allowed == 'true' && steps.config.outputs.enabled == 'true'
        run: pip install -r requirements.txt

      - name: Run fix agent
        if: steps.security.outputs.allowed == 'true' && steps.config.outputs.enabled == 'true'
        id: fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "changes=no" >> $GITHUB_OUTPUT
          if [ ! -s "$RUNNER_TEMP/review-comments.json" ] || [ "$(cat "$RUNNER_TEMP/review-comments.json")" = "[]" ]; then
            echo "No review comments to process."
            exit 0
          fi
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "Set ANTHROPIC_API_KEY as a repository secret to enable the agent."
            exit 0
          fi
          python scripts/fix_review_agent.py \
            --comments "$RUNNER_TEMP/review-comments.json" \
            --repo-root . \
            --model "${{ steps.config.outputs.model }}" \
            --min-confidence "${{ steps.config.outputs.confidence_threshold }}" \
            || true
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Apply fixes from code review"
            git push
            echo "changes=yes" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (optional)
        if: steps.fix.outputs.changes == 'yes' && steps.pr_and_comments.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr_and_comments.outputs.pr_number }}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'ðŸ¤– **Code review fixes applied** â€” changes have been committed to this branch.'
            });
            core.info(`Posted comment on PR #${prNumber}`);
